!function(n,t){var e,r;"undefined"!=typeof module&&module.exports,e=window._,window.THREE,window.Laya,r=function(){return{tick:function(){}}};function add(n,t,e){e.x=n.x+t.x,e.y=n.y+t.y,e.z=n.z+t.z}function roundNumber(n,t){var e=new Number(n+"").toFixed(parseInt(t));return parseFloat(e)}var o,i=1,c={width:30};function array_intersect(){var n,t,e,r,o,i,c=[],u={};for(i=arguments.length-1,e=arguments[0].length,t=0,n=0;n<=i;n++)(r=arguments[n].length)<e&&(t=n,e=r);for(n=0;n<=i;n++){o=arguments[r=n===t?0:n||t].length;for(var s=0;s<o;s++){var a=arguments[r][s];u[a]===n-1?n===i?(c.push(a),u[a]=0):u[a]=n:0===n&&(u[a]=0)}}return c}var u=function(n){console.log("Vertices:",n.vertices.length,"polygons:",n.faces.length);var t=[],u=n.vertices,s=n.faceVertexUvs;o=new r("Building polygons      [:bar] :percent",e.extend(c,{total:n.faces.length})),e.each(n.faces,function(n){o.tick(),t.push({id:i++,vertexIds:[n.a,n.b,n.c],centroid:n.centroid,normal:n.normal,neighbours:[]})});var a={polygons:t,vertices:u,faceVertexUvs:s};return o=new r("Calculating neighbours [:bar] :percent",e.extend(c,{total:t.length})),e.each(t,function(n){o.tick(),function(n,t){n.neighbours=[];for(var e=0,r=t.polygons.length;e<r;e++)n!==t.polygons[e]&&(h(n.centroid,t.polygons[e].centroid)>1e4||array_intersect(n.vertexIds,t.polygons[e].vertexIds).length>=2&&n.neighbours.push(t.polygons[e]))}(n,a)}),a},s=function(n){return function(n){var t,e,r;for(t=0,e=n.faces.length;t<e;t++)(r=n.faces[t]).centroid=new Laya.Vector3(0,0,0),add(r.centroid,n.vertices[r.a],r.centroid),add(r.centroid,n.vertices[r.b],r.centroid),add(r.centroid,n.vertices[r.c],r.centroid),o=r.centroid,i=1/3,c=r.centroid,c.x=o.x*i,c.y=o.y*i,c.z=o.z*i;var o,i,c}(n),n.mergeVertices(),u(n)},a=function(n){var t={};e.each(n.vertices,function(n){n.x=roundNumber(n.x,2),n.y=roundNumber(n.y,2),n.z=roundNumber(n.z,2)}),t.vertices=n.vertices;var i=function(n){var t=n.polygons;n.vertices;o=new r("Building polygon groups[:bar] :percent",e.extend(c,{total:t.length}));var i=[],u=0,s=function(n){e.each(n.neighbours,function(t){e.isUndefined(t.group)&&(t.group=n.group,s(t))})};return e.each(t,function(n,t){o.tick(),e.isUndefined(n.group)&&(n.group=u++,s(n)),i[n.group]||(i[n.group]=[]),i[n.group].push(n)}),console.log("Groups built: ",i.length),i}(n);t.groups=[];var u=function(n,t){for(var e=0;e<n.length;e++)if(t===n[e])return e};return o=new r("Grouping               [:bar] :percent",e.extend(c,{total:i.length})),e.each(i,function(n){o.tick();var r=[];e.each(n,function(t){var o=[];e.each(t.neighbours,function(t){o.push(u(n,t))});var i=[];e.each(t.neighbours,function(n){var r,o,c,u;i.push((r=n,o=t.vertexIds,c=r.vertexIds,u=[],e.each(o,function(n){e.contains(c,n)&&u.push(n)}),u.length<2?[]:(e.contains(u,o[0])&&e.contains(u,o[o.length-1])&&o.push(o.shift()),e.contains(u,c[0])&&e.contains(u,c[c.length-1])&&c.push(c.shift()),u=[],e.each(o,function(n){e.contains(c,n)&&u.push(n)}),u)))}),t.centroid.x=roundNumber(t.centroid.x,2),t.centroid.y=roundNumber(t.centroid.y,2),t.centroid.z=roundNumber(t.centroid.z,2),r.push({id:u(n,t),neighbours:o,vertexIds:t.vertexIds,centroid:t.centroid,portals:i})}),t.groups.push(r)}),t};function BinaryHeap(n){this.content=[],this.scoreFunction=n}BinaryHeap.prototype={push:function(n){this.content.push(n),this.sinkDown(this.content.length-1)},pop:function(){var n=this.content[0],t=this.content.pop();return this.content.length>0&&(this.content[0]=t,this.bubbleUp(0)),n},remove:function(n){var t=this.content.indexOf(n),e=this.content.pop();t!==this.content.length-1&&(this.content[t]=e,this.scoreFunction(e)<this.scoreFunction(n)?this.sinkDown(t):this.bubbleUp(t))},size:function(){return this.content.length},rescoreElement:function(n){this.sinkDown(this.content.indexOf(n))},sinkDown:function(n){for(var t=this.content[n];n>0;){var e=(n+1>>1)-1,r=this.content[e];if(!(this.scoreFunction(t)<this.scoreFunction(r)))break;this.content[e]=t,this.content[n]=r,n=e}},bubbleUp:function(n){for(var t=this.content.length,e=this.content[n],r=this.scoreFunction(e);;){var o=n+1<<1,i=o-1,c=null;if(i<t){var u=this.content[i],s=this.scoreFunction(u);s<r&&(c=i)}if(o<t){var a=this.content[o];this.scoreFunction(a)<(null===c?r:s)&&(c=o)}if(null===c)break;this.content[n]=this.content[c],this.content[c]=e,n=c}}};var h=function(n,t){var e=n.x-t.x,r=n.y-t.y,o=n.z-t.z;return e*e+r*r+o*o},l={},f={init:function(n){for(var t=0;t<n.length;t++){var e=n[t];e.f=0,e.g=0,e.h=0,e.cost=1,e.visited=!1,e.closed=!1,e.parent=null}},cleanUp:function(n){for(var t=0;t<n.length;t++){var e=n[t];delete e.f,delete e.g,delete e.h,delete e.cost,delete e.visited,delete e.closed,delete e.parent}},heap:function(){return new BinaryHeap(function(n){return n.f})},search:function(n,t,e,r,o){l[n]||(l[n]={}),l[n][t]||(l[n][t]=!1),l[n][t]||(f.init(e),l[n][t]=!0);var i=[],c=f.heap();for(c.push(r),i.push(r);c.size()>0;){var u=c.pop();if(u===o){for(var s=u,a=[];s.parent;)a.push(s),s=s.parent;return this.init(i),a.reverse()}u.closed=!0;for(var h=f.neighbours(e,u),p=0,d=h.length;p<d;p++){var v=h[p];if(!v.closed){var g=u.g+v.cost,x=v.visited;(!x||g<v.g)&&(v.visited=!0,v.parent=u,!v.centroid||o.centroid,v.h=v.h||f.heuristic(v.centroid,o.centroid),v.g=g,v.f=v.g+v.h,x?c.rescoreElement(v):(c.push(v),i.push(v)))}}}return this.init(i),[]},heuristic:function(n,t){return h(n,t)},neighbours:function(n,t){for(var e=[],r=0;r<t.neighbours.length;r++)e.push(n[t.neighbours[r]]);return e}};h=function(n,t){var e=n.x-t.x,r=n.y-t.y,o=n.z-t.z;return e*e+r*r+o*o};function triarea2(n,t,e){var r=t.x-n.x,o=t.z-n.z;return(e.x-n.x)*o-r*(e.z-n.z)}function vequal(n,t){return h(n,t)<1e-5}function Channel(){this.portals=[]}Channel.prototype.push=function(n,t){void 0===t&&(t=n),this.portals.push({left:n,right:t})},Channel.prototype.stringPull=function(){var n,t,e,r=this.portals,o=[],i=0,c=0,u=0;n=r[0].left,t=r[0].left,e=r[0].right,o.push(n);for(var s=1;s<r.length;s++){var a=r[s].left,h=r[s].right;if(triarea2(n,e,h)<=0){if(!(vequal(n,e)||triarea2(n,t,h)>0)){o.push(t),t=n=t,e=n,c=i=c,u=i,s=i;continue}e=h,u=s}if(triarea2(n,t,a)>=0){if(!(vequal(n,t)||triarea2(n,e,a)<0)){o.push(e),t=n=e,e=n,c=i=u,u=i,s=i;continue}t=a,c=s}}return 0!==o.length&&vequal(o[o.length-1],r[r.length-1].left)||o.push(r[r.length-1].left),this.path=o,o};var p={},d={};e.extend(n,{buildNodes:function(n){var t=s(n);return a(t)},setZoneData:function(n,t){p[n]=t,d[n]={}},getGroup:function(n,t){if(!p[n])return null;var r=null,o=Math.pow(50,2);return e.each(p[n].groups,function(n,i){e.each(n,function(n){var e=h(n.centroid,t);e<o&&(r=i,o=e)})}),r},quickLocation:function(n,t,r,o){d[t][r]||(d[t][r]={});let i=Math.floor(n.x/1),c=(Math.floor(n.y/1),Math.floor(n.z/1)),u=i+"_"+c;if(!d[t][r][u]){let n=[],o=[],a=2500;var s=p[t].groups[r];e.each(s,function(t){var e=t.centroid.x-i,r=t.centroid.z-c,u=e*e+r*r;if(u<a){o.length>=10&&(o.pop(),n.pop());let e=o.length-1;for(;e>=0&&!(o[e]<u);e--);n.splice(e+1,0,t),o.splice(e+1,0,u),a=o[o.length-1]}},this),d[t][r][u]=n}var a=null,l=Math.pow(50,2),f=p[t].vertices;return e.each(d[t][r][u],function(t){var r=h(t.centroid,n);r<l&&(!o||function(n,t,r){t.centroid;var o=1e5,i=-1e5,c=[];return e.each(t.vertexIds,function(n){o=Math.min(r[n].y,o),i=Math.max(r[n].y,i),c.push(r[n])}),!!(n.y<i+.5&&n.y>o-.5&&function(n,t){for(var e=!1,r=-1,o=n.length,i=o-1;++r<o;i=r)(n[r].z<=t.z&&t.z<n[i].z||n[i].z<=t.z&&t.z<n[r].z)&&t.x<(n[i].x-n[r].x)*(t.z-n[r].z)/(n[i].z-n[r].z)+n[r].x&&(e=!e);return e}(c,n))}(n,t,f))&&(a=t,l=r)},this),a},getRandomNode:function(n,t,r,o,i){if(!p[n])return null;r=r||null,o=o||0;var c=[],u=p[n].groups[t];e.each(u,function(n){r&&o?h(r,n.centroid)<o*o&&c.push(n.centroid):c.push(n.centroid)});let s=Math.floor(c.length*i);return c[s]||null},findPath:function(n,t,r,o){var i=p[r].groups[o],c=p[r].vertices,u=this.quickLocation(n,r,o,!1),s=this.quickLocation(t,r,o,!0);if(!u||!s)return null;var a=f.search(r,o,i,u,s),h=function(n,t){for(var e=0;e<n.neighbours.length;e++)if(n.neighbours[e]===t.id)return n.portals[e]},l=new Channel;l.push(n);for(var d=0;d<a.length;d++){var v=a[d],g=a[d+1];if(g){var x=h(v,g);l.push(c[x[0]],c[x[1]])}}l.push(t),l.stringPull();var b=[];return e.each(l.path,function(n){var t=new Laya.Vector3(n.x,n.y,n.z);b.push(t)}),b.shift(),b}})}(window.patrol=window.patrol||{},patrol);